<div class="container mt-4">
  <div class="mb-2">
    <button class="btn btn-sm btn-icon" (click)="back()" aria-label="Back to accounts"><i class="bi bi-arrow-left"></i> <span class="visually-hidden">Back</span></button>
  </div>

  <div class="card">
    <div class="card-header">Account Details</div>
    <div class="card-body">
      <div *ngIf="accountMeta; else loadingMeta">
        <div class="mb-2"><strong>ID:</strong> {{accountMeta.id || accountMeta.accountId}}</div>
        <div class="mb-2"><strong>Type:</strong> {{accountMeta.type}}</div>
        <div class="mb-2"><strong>Balance:</strong> {{accountMeta.balance | number:'1.2-2'}}</div>
        <div *ngIf="accountMeta.customerDTO" class="mb-2"><strong>Customer:</strong> {{accountMeta.customerDTO.name}} ({{accountMeta.customerDTO.email}})</div>
        <div *ngIf="accountMeta.createdAt" class="mb-2"><strong>Created:</strong> {{accountMeta.createdAt | date:'short'}}</div>
      </div>
      <ng-template #loadingMeta>
        <div class="text-muted">Loading account…</div>
      </ng-template>
    </div>
  </div>

  <div class="card mt-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>Operations</strong>
    </div>
    <div class="card-body">
      <div *ngIf="loading" class="text-center py-3">Loading operations…</div>

      <div class="row">
        <div class="col-md-7">

          <div *ngIf="!loading && opsList?.length" class="ops-scroll mb-3" role="list">
            <div *ngFor="let op of opsList" class="op-item d-flex justify-content-between align-items-start" role="listitem">
              <div>
                <div class="meta"><span class="muted">{{op.operationDate | date:'dd-MM-yyyy HH:mm'}}</span></div>
                <div class="muted small">{{op.type}} — {{op.description || '—'}}</div>
              </div>
              <div class="text-end">
                <div class="amount text-muted">{{op.amount | number:'1.2-2'}}</div>
              </div>
            </div>
          </div>

          <div *ngIf="!loading && !opsList?.length" class="text-muted">No operations available.</div>

          <div *ngIf="accountDetails && accountDetails.totalPages > 1 && hasMoreOps" class="text-center mt-2">
            <button class="btn btn-sm btn-outline-secondary" (click)="loadMoreOps()" [disabled]="loadingMore"> 
              <span *ngIf="loadingMore" class="spinner-border spinner-border-sm me-2"></span>Load more
            </button>
          </div>

        </div>

        <div class="col-md-5">
          <div class="op-form p-3 border rounded">

            <div *ngIf="savedMessage" class="alert alert-success" role="status">{{ savedMessage }}</div>

            <label class="form-label d-block mb-2">Operation Type</label>
            <div class="btn-group op-type-btns mb-3" role="group" aria-label="Operation types">
              <button type="button" class="btn" [class.active]="operationForm.value.operationType==='DEBIT'" (click)="operationForm.patchValue({operationType:'DEBIT'})">DEBIT</button>
              <button type="button" class="btn" [class.active]="operationForm.value.operationType==='CREDIT'" (click)="operationForm.patchValue({operationType:'CREDIT'})">CREDIT</button>
              <button type="button" class="btn" [class.active]="operationForm.value.operationType==='TRANSFER'" (click)="operationForm.patchValue({operationType:'TRANSFER'})">TRANSFER</button>
            </div>

            <form [formGroup]="operationForm" (ngSubmit)="handleOperation()" novalidate>
              <div class="mb-2" *ngIf="operationForm.value.operationType==='TRANSFER'">
                <label class="form-label">Destination Account</label>
                <input type="text" formControlName="accountDestination" class="form-control" placeholder="Destination account id">
                <div *ngIf="operationForm.get('accountDestination')?.invalid && (operationForm.get('accountDestination')?.touched)" class="text-danger small">Destination account is required for transfers.</div>
              </div>

              <div class="mb-2">
                <label class="form-label">Amount</label>
                <input type="number" step="0.01" formControlName="amount" class="form-control" placeholder="0.00">
                <div *ngIf="operationForm.get('amount')?.invalid && (operationForm.get('amount')?.touched)" class="text-danger small">
                  <div *ngIf="operationForm.get('amount')?.errors?.['required']">Amount is required.</div>
                  <div *ngIf="operationForm.get('amount')?.errors?.['min']">Amount must be greater than zero.</div>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea formControlName="description" class="form-control" rows="3" placeholder="Optional description"></textarea>
              </div>

              <div class="d-grid">
                <button class="btn btn-brand" [disabled]="isSubmitting || operationForm.invalid"> 
                  <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                  Create Operation
                </button>
              </div>
            </form>

          </div>
        </div>
      </div>

    </div>
  </div>
</div>